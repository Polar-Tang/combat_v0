local require = require(script.Parent.loader).load(script)

--||Modules||--

local WeaponBinder = require("WeaponBinder")

local AnimationClient = require("AnimationClient")




-- SETTING CHARACTER ATTRIBUTES TO THE CHARACTER, REDUCES ITS VELOCITY
------------------------------------------------------------------------------------------------------------------
local BlockingServer = {}
BlockingServer.Type = "Defense"

function BlockingServer.Execute(character, action)
	--||Settings||--
	local parry_time = WeaponBinder.parry_time
local block_reset_time = WeaponBinder.block_reset_time
local walk_speed_normal = WeaponBinder.walk_speed_normal
local walk_speed_blocking = WeaponBinder.walk_speed_blocking
	local isBlocking = character:GetAttribute("IsBlocking")
	local currentTime = tick()
	print("IsBlocking", character:GetAttribute("IsBlocking"))
	if not isBlocking then
		character:SetAttribute("IsBlocking", true)
		character:SetAttribute("LastStopTime", 0)
		character.Humanoid.WalkSpeed = walk_speed_blocking
		AnimationClient.Blocking(character)

		task.spawn(function()
			character:SetAttribute("Parrying", true)
			task.wait(parry_time)
			character:SetAttribute("Parrying", false)
		end)
	elseif isBlocking then
		character:SetAttribute("IsBlocking", false)
		character:SetAttribute("Parrying", false)
		character:SetAttribute("LastStopTime", currentTime)
		character.Humanoid.WalkSpeed = walk_speed_normal
		AnimationClient.UnBlocking(character)
	end
end

local connectionRunning = {}

local function onBlockingChanged(char)
	if char:GetAttribute("Blocking") > 0 and connectionRunning[char] == nil then
		coroutine.wrap(function()
			connectionRunning[char] = true
			while char:GetAttribute("Blocking") > 0 do -- Connect the loop only when Blocking is greater than 0
				task.wait(1)
				for i, char in pairs(game.Workspace:GetDescendants()) do
					if char:IsA("Humanoid") then
						local character = char.Parent
						if character then
							local isBlocking = character:GetAttribute("IsBlocking")
							local lastStopTime = character:GetAttribute("LastStopTime") or 0
							local currentTime = tick()

							if not isBlocking and currentTime - lastStopTime >= block_reset_time then
								character:SetAttribute(
									"Blocking",
									math.max(0, character:GetAttribute("Blocking") - 1.5)
								)
							end
						end
					end
				end
			end
			connectionRunning[char] = nil -- Disconnect the loop when Blocking becomes 0
		end)()
	end
end

--Checking for the block stuff for players and npcs
game.Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(char)
		char:GetAttributeChangedSignal("Blocking"):Connect(function()
			onBlockingChanged(char)
		end)
	end)
end)

--[[for i,v in pairs(workspace.Npcs:GetChildren()) do
	v:GetAttributeChangedSignal("Blocking"):Connect(function()
		onBlockingChanged(v)
	end)
end
]]

return BlockingServer
