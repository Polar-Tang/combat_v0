local require = require(script.Parent.loader).load(script)

-- Binders
local AnimationHandler = require("AnimationHandler")
local WeaponBinder = require("WeaponBinder")

--||Helpers||--

local hitbox_start_stop = require("hitbox_start_stop")
local get_trail = require("get_trail")
--utils
local hitTouchTemplate = require("hitTouchTemplate")

local BaseAbility = require("BaseAbility")

local Basic = setmetatable({}, BaseAbility)
Basic.__index = Basic

function Basic.new(config)
	local self = BaseAbility.new(config)
	setmetatable(self, Basic)
	return self
end

-- RETURN THE WEAPON ANIMATION FOR THE NEXT COMBO
function Basic:getSwingAnimation(): string
	local char = self.Character
	local combo = char:GetAttribute("Combo")

	return "Swing" .. combo
end

--[[
function for changing the players combo
set the current combo as an attribute
and stores the cooldown
]]
function Basic:_ChangeCombo()
	-- SET THE COMBO ATT
	local char = self.Character
	local lastSwing = self._lastSwing
	local Max_Combo = self._maxCombo
	local combo = char:GetAttribute("Combo")

	if lastSwing[char] then
		local passedTime = tick() - lastSwing[char]
		if passedTime <= 2 then --change the 2 if you wan't the combo to reset faster/slower
			if combo >= Max_Combo then
				char:SetAttribute("Combo", 1)
			else
				char:SetAttribute("Combo", combo + 1)
			end
		else
			char:SetAttribute("Combo", 1)
		end
	end
	-- sets the Tick for cc
	self._cooldownController:init(self._cooldown)
end

function Basic:Execute(newHitbox)
	local CHAR = self.Character

	local WeaponData = WeaponBinder:Get(CHAR)
	local HUM = CHAR:WaitForChild("Humanoid")
	local tool_name = WeaponData.tool_name

	local swingName: string = Basic:getSwingAnimation()
	local animHandler = AnimationHandler:Get(CHAR)
	animHandler:LoadAnimation(true, swingName)

	local current_combo = CHAR:GetAttribute("Combo")
	self:_ChangeCombo()

	local max_combo = WeaponData.max_combo
	local hitFx = function()
		
		CHAR:SetAttribute("Attacking", false)
		hitbox_start_stop(CHAR, newHitbox)
		--if the combo is the last hit then let him not attack for longer
		if current_combo == max_combo then
			task.wait(1)
		else
			task.wait(WeaponData.swing_reset)
		end
		CHAR:SetAttribute("Swing", false)
	end
	animHandler:OnSignal({
		callback = hitFx,
		animationName = swingName,
		animationEventName = "Hit",
	})
	local hitEnd = function(track: AnimationTrack)
		-- Ithink this is handled by autodestroy
		--newHitbox:Stop()
		local trail = get_trail(CHAR)
		if CHAR:FindFirstChild(tool_name) and trail then
			trail.Enabled = false
		end
		if not CHAR:GetAttribute("IsBlocking") then
			HUM.WalkSpeed = 14
			HUM.JumpHeight = 6.5
		end
	end

	animHandler:OnSignal({
		callback = hitEnd,
		animationName = swingName,
		animationEventName = "EndedCon",
	})

	WeaponData:PlaySwingSound()

	local getStrnght = function(enemyHum)
		local Strenght = 10
		if current_combo == max_combo then
			Strenght = 35
		end

		return { Strength = Strenght }
	end

	newHitbox.Touched:Connect(hitTouchTemplate(newHitbox, getStrnght))
end

return Basic
