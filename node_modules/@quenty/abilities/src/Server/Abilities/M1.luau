local Debris = game:GetService("Debris")
local SoundService = game:GetService("SoundService")
local SoundFolder = SoundService.SFX
local WeaponSoundFolder = SoundFolder.Weapons
local require = require(script.Parent.loader).load(script)

-- Binders
local AnimationHandler = require("AnimationHandler")

--||Helpers||--

local hitbox_start_stop = require("hitbox_start_stop")
--utils
local hitTouchTemplate = require("hitTouchTemplate")

local AttackBaseAbility = require("AttackBaseAbility")

local Basic = setmetatable({}, AttackBaseAbility)
Basic.__index = Basic

-- Config is the data created by the weapon through the builder
function Basic.new(config)
	local self = setmetatable(AttackBaseAbility.new(config), Basic)
	return self
end

-- RETURN THE WEAPON ANIMATION FOR THE NEXT COMBO
function Basic:getSwingAnimation(): string
	print("self ", self)
	local char = self.character
	local combo = char:GetAttribute("Combo")

	return "Swing" .. combo
end

--[[
function for changing the players combo
set the current combo as an attribute
and stores the cooldown
]]
function Basic:_ChangeCombo()
	-- SET THE COMBO ATT
	local char = self.character
	local lastSwing = self._lastSwing
	local Max_Combo = self._maxCombo
	local combo = char:GetAttribute("Combo")

	if lastSwing[char] then
		local passedTime = tick() - lastSwing[char]
		if passedTime <= 2 then --change the 2 if you wan't the combo to reset faster/slower
			if combo >= Max_Combo then
				char:SetAttribute("Combo", 1)
			else
				char:SetAttribute("Combo", combo + 1)
			end
		else
			char:SetAttribute("Combo", 1)
		end
	end
	-- sets the Tick for cc
	self._cooldownController:init(self._cooldown)
end

function Basic:Execute()
	local serviceBag = self._serviceBag
	local newHitbox = self:_createHitBox()
	local CHAR = self.character

	local HUM = CHAR:WaitForChild("Humanoid")

	local swingName: string = Basic:getSwingAnimation()
	local animHandler = AnimationHandler:Get(CHAR)
	animHandler:LoadAnimation(true, swingName)

	local current_combo = CHAR:GetAttribute("Combo")
	self:_ChangeCombo()

	local max_combo = self.max_combo
	local hitFx = function()
		
		CHAR:SetAttribute("Attacking", false)
		hitbox_start_stop(CHAR, newHitbox)
		--HERE SHOULD GO THE COOLDOWNS
		-- if current_combo == max_combo then
		-- 	task.wait(1)
		-- else
		-- 	task.wait(self.swing_reset)
		-- end
		--_cooldown
		CHAR:SetAttribute("Swing", false)
	end
	animHandler:OnSignal({
		callback = hitFx,
		animationName = swingName,
		animationEventName = "Hit",
	})
	local hitEnd = function(track: AnimationTrack)
		-- Ithink this is handled by autodestroy
		--newHitbox:Stop()
		
		if not CHAR:GetAttribute("IsBlocking") then
			HUM.WalkSpeed = 14
			HUM.JumpHeight = 6.5
		end
	end

	animHandler:OnSignal({
		callback = hitEnd,
		animationName = swingName,
		animationEventName = "EndedCon",
	})

	--WeaponData:PlaySwingSound()
	Basic:PlaySound("Hit", 2)
	local getStrnght = function(enemyHum)
		local Strenght = 10
		if current_combo == max_combo then
			Strenght = 35
		end

		return { Strength = Strenght }
	end

	newHitbox.Touched:Connect(hitTouchTemplate(newHitbox, getStrnght, serviceBag))
end

function Basic:PlaySound(nameSound: string, lifeTime: number?)
	local dur = lifeTime or 2
	local Sound = WeaponSoundFolder[nameSound]:Clone()
	Sound.Parent = self.character:WaitForChild("HumanoidRootPart")
	Sound:Play()
	Debris:AddItem(Sound, dur)

end

return Basic
